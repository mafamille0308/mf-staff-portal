<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ma famille staff portal</title>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <h1>Staff Portal (Test)</h1>

  <!-- ログインボタン -->
  <div id="g_id_onload"
       data-client_id="721404541012-sdsefklaglk2801a7qai38ooslon2gj3.apps.googleusercontent.com"
       data-callback="onGoogleLogin">
  </div>
  <div class="g_id_signin"></div>

  <pre id="log"></pre>

  <script>
    function log(msg) {
      document.getElementById('log').textContent += msg + "\n";
    }

    // Googleログイン後に呼ばれる
    function onGoogleLogin(response) {
      log("id_token received");
      log(response.credential);

      // ここではまだ GAS には送らない
      // 次ステップで listVisits を叩く
    }
  </script>
</body>
</html>

<script>
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbzOikwjZQuTyWa_LDHGH_jVGugkMfWqFEiGmKySUea4MP-Hlh20RXRK2H9Ihrr5nYvdYA/exec";

  function log(msg) {
    document.getElementById('log').textContent += msg + "\n";
  }

  async function callGas(action, idToken, extra = {}) {
    const payloadObj = Object.assign({ action, id_token: idToken }, extra);
    const body = new URLSearchParams({ payload: JSON.stringify(payloadObj) });

    // CORS/プリフライトを避ける：余計なヘッダを付けない
    const res = await fetch(GAS_EXEC_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body
    });

    // ここで CORS が厳しい環境だと res.json() が読めない場合があります
    const text = await res.text();
    return text;
  }

  function onGoogleLogin(response) {
    const idToken = response.credential;
    log("id_token received");
    log(idToken);

    // まずは listVisits を叩く（期間は仮でOK）
    callGas("listVisits", idToken, {
      date_from: "2025-12-01T00:00:00+09:00",
      date_to: "2025-12-31T23:59:59+09:00"
    })
  }
</script>
